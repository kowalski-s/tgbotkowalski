# Решение проблем

## Проблема: Проверка подписки не работает

### Симптомы:
- Вы подписаны на канал, но бот пишет "Вы не подписались"
- В логах: `Пользователь XXXXX не прошел проверку подписки`

### Диагностика:

**Шаг 1: Запустите тест канала**
```bash
python test_channel.py
```

Этот скрипт проверит:
- Правильность BOT_TOKEN
- Доступность канала
- Права бота в канале
- Подписку администратора

### Причины и решения:

#### ❌ Причина 1: Бот не добавлен в администраторы канала

**Как проверить:**
- Откройте канал в Telegram
- Настройки → Администраторы
- Проверьте, есть ли ваш бот в списке

**Решение:**
1. Откройте канал
2. Настройки → Администраторы
3. "Добавить администратора"
4. Найдите своего бота (по @username)
5. Включите ЛЮБОЕ право (например, "Удаление сообщений")
6. Сохраните

**ВАЖНО:** Боту нужно быть администратором, чтобы проверять подписку!

---

#### ❌ Причина 2: Неправильный CHANNEL_ID в .env

**Как проверить .env:**
```env
CHANNEL_ID=@your_channel  # Для публичных каналов
# или
CHANNEL_ID=-1001234567890  # Числовой ID
```

**Варианты указания CHANNEL_ID:**

**Вариант A: Использовать @username**
- Плюсы: просто
- Минусы: у канала должен быть публичный username

```env
CHANNEL_ID=@your_channel_name
```

**Вариант Б: Использовать числовой ID**
- Плюсы: работает для любых каналов
- Минусы: нужно узнать ID

Как узнать числовой ID:
1. Перешлите любое сообщение из канала в [@username_to_id_bot](https://t.me/username_to_id_bot)
2. Бот покажет ID (формат: `-1001234567890`)
3. Скопируйте ID **вместе с минусом**!

```env
CHANNEL_ID=-1001234567890
```

**Решение:**
1. Откройте .env файл
2. Проверьте CHANNEL_ID
3. Если используете @username - убедитесь, что у канала есть публичный username
4. Если используете числовой ID - убедитесь, что он с минусом
5. Перезапустите бота

---

#### ❌ Причина 3: Бот не имеет нужных прав

**Как проверить:**
```bash
python test_channel.py
```

Скрипт покажет статус бота и его права.

**Решение:**
1. Откройте канал
2. Настройки → Администраторы
3. Найдите бота в списке
4. Нажмите на него
5. Включите права (минимум одно любое)
6. Сохраните

---

#### ❌ Причина 4: Используете приватный канал без числового ID

**Симптом:**
- У канала нет @username
- Используете в .env формат `CHANNEL_ID=@...`

**Решение:**
Для приватных каналов нужно использовать числовой ID:
1. Получите ID через [@username_to_id_bot](https://t.me/username_to_id_bot)
2. Укажите в .env: `CHANNEL_ID=-1001234567890`

---

## Пошаговая инструкция исправления

### 1. Остановите бота
```bash
Ctrl+C  # если запущен локально
# или
docker-compose down  # если в Docker
```

### 2. Проверьте настройки канала

**A. Убедитесь, что бот - администратор:**
- Откройте канал
- Настройки → Администраторы
- Если бота нет - добавьте его
- Включите любое право

**B. Проверьте CHANNEL_ID в .env:**
```bash
# Откройте .env
notepad .env  # Windows
nano .env     # Linux

# Проверьте строку CHANNEL_ID
```

Варианты:
- `CHANNEL_ID=@your_channel` - для публичных каналов
- `CHANNEL_ID=-1001234567890` - числовой ID (НЕ ЗАБУДЬТЕ МИНУС!)

### 3. Запустите тест
```bash
python test_channel.py
```

Если тест прошел ✅ - переходите к шагу 4.
Если тест провалился ❌ - следуйте инструкциям в выводе.

### 4. Запустите бота
```bash
python -m bot.main  # локально
# или
docker-compose up -d  # Docker
```

### 5. Протестируйте
1. Откройте бота в Telegram
2. Отправьте `/start`
3. Если вы подписаны - должны сразу получить материалы
4. Если нет - подпишитесь и нажмите "Я подписался"

---

## Другие проблемы

### PDF файл не отправляется

**Причина:** Файл не найден

**Решение:**
```bash
# Проверьте наличие файла
ls data/bonus.pdf  # Linux/Mac
dir data\bonus.pdf # Windows

# Если файла нет - скопируйте его
cp /path/to/your/file.pdf data/bonus.pdf
```

---

### Бот не отвечает на сообщения

**Причина:** Бот не запущен или ошибка в коде

**Решение:**
```bash
# Проверьте логи
docker-compose logs -f  # Docker
# или просто посмотрите в терминал где запущен бот

# Перезапустите
docker-compose restart  # Docker
# или Ctrl+C и снова python -m bot.main
```

---

### Статистика не работает

**Причина:** Вы не администратор

**Решение:**
1. Проверьте ADMIN_ID в .env
2. Узнайте свой ID: [@userinfobot](https://t.me/userinfobot)
3. Укажите правильный ID в .env
4. Перезапустите бота

---

## Полезные команды для диагностики

```bash
# Проверить конфигурацию
python check_config.py

# Протестировать канал
python test_channel.py

# Просмотр логов (Docker)
docker-compose logs -f

# Просмотр логов (локально)
cat bot.log  # Linux/Mac
type bot.log # Windows

# Перезапуск бота (Docker)
docker-compose restart

# Остановка бота (Docker)
docker-compose down
```

---

## Все еще не работает?

1. **Проверьте логи подробно:**
   - Запустите бота с подробным логированием
   - Посмотрите точное сообщение об ошибке

2. **Проверьте правильность всех данных:**
   ```bash
   python check_config.py
   python test_channel.py
   ```

3. **Попробуйте создать тестовый канал:**
   - Создайте новый публичный канал
   - Дайте ему @username
   - Добавьте бота в админы
   - Используйте `CHANNEL_ID=@test_channel`

4. **Проверьте, что Telegram Bot API доступен:**
   ```bash
   ping api.telegram.org
   ```

---

## Контрольный чек-лист ✅

Перед запуском убедитесь:

- [ ] Создан бот через @BotFather
- [ ] BOT_TOKEN скопирован в .env
- [ ] ADMIN_ID указан правильно (проверьте через @userinfobot)
- [ ] Канал создан
- [ ] CHANNEL_ID указан правильно в .env
- [ ] Бот добавлен в администраторы канала
- [ ] У бота есть права в канале (минимум одно)
- [ ] PDF файл находится в папке data/
- [ ] `python test_channel.py` проходит успешно ✅

Если все пункты выполнены - бот должен работать!
