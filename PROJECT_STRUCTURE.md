# Структура проекта

```
tgbotkowalski/
│
├── bot/                          # Основной код бота
│   ├── __init__.py               # Инициализация пакета
│   ├── main.py                   # Точка входа, запуск бота
│   ├── config.py                 # Конфигурация из .env
│   │
│   ├── handlers/                 # Обработчики команд и сообщений
│   │   ├── __init__.py           # Главный роутер
│   │   ├── start.py              # Команда /start и проверка подписки
│   │   ├── admin.py              # Админские команды (/stats, ответы)
│   │   └── messages.py           # Обработка сообщений от пользователей
│   │
│   ├── keyboards/                # Клавиатуры для бота
│   │   ├── __init__.py
│   │   └── inline.py             # Inline кнопки подписки
│   │
│   ├── database/                 # Работа с базой данных
│   │   ├── __init__.py
│   │   ├── models.py             # SQL схемы таблиц
│   │   └── db.py                 # Класс Database для работы с SQLite
│   │
│   └── utils/                    # Утилиты
│       ├── __init__.py
│       └── checks.py             # Проверка подписки на канал
│
├── data/                         # Данные бота
│   ├── README.txt                # Инструкция по размещению PDF
│   ├── bonus.pdf                 # PDF файл для отправки (добавить)
│   └── bot.db                    # SQLite база (создается автоматически)
│
├── .env                          # Переменные окружения (НЕ в git!)
├── .env.example                  # Пример .env файла
├── .gitignore                    # Исключения для git
├── .dockerignore                 # Исключения для Docker
│
├── requirements.txt              # Python зависимости
├── Dockerfile                    # Конфигурация Docker образа
├── docker-compose.yml            # Docker Compose для запуска
│
├── check_config.py               # Скрипт проверки конфигурации
│
├── README.md                     # Основное описание проекта
├── claude.md                     # Подробная документация и план
├── SETUP.md                      # Полная инструкция по настройке
├── QUICKSTART.md                 # Краткая инструкция быстрого старта
├── COMMANDS.md                   # Шпаргалка по командам
└── PROJECT_STRUCTURE.md          # Этот файл (структура проекта)
```

## Описание модулей

### bot/main.py
- Точка входа в приложение
- Инициализация бота и диспетчера
- Подключение к БД
- Middleware для передачи db в обработчики
- Запуск polling

### bot/config.py
- Загрузка переменных из .env
- Валидация обязательных параметров
- Класс Config с настройками

### bot/handlers/
Модули обработчиков команд:

- **start.py**: Воронка подписки
  - `/start` - приветствие
  - Проверка подписки на канал
  - Выдача материалов

- **admin.py**: Администрирование
  - `/stats` - статистика
  - Reply на сообщения - ответ пользователю

- **messages.py**: Двусторонняя связь
  - Прием сообщений от пользователей
  - Пересылка администратору
  - Сохранение в БД

### bot/keyboards/inline.py
- Inline клавиатура с кнопками:
  - "Подписаться на канал"
  - "Я подписался"

### bot/database/
Работа с SQLite:

- **models.py**: SQL запросы для создания таблиц
  - users - пользователи
  - messages - сообщения
  - indexes - индексы

- **db.py**: Класс Database
  - Подключение/отключение
  - CRUD операции с пользователями
  - Сохранение сообщений
  - Получение статистики

### bot/utils/checks.py
- Проверка подписки через Telegram Bot API
- Обработка ошибок

## База данных (SQLite)

### Таблица: users
| Поле         | Тип       | Описание                    |
|--------------|-----------|-----------------------------|
| id           | INTEGER   | PRIMARY KEY (auto)          |
| user_id      | INTEGER   | Telegram ID (UNIQUE)        |
| username     | TEXT      | @username                   |
| first_name   | TEXT      | Имя                         |
| last_name    | TEXT      | Фамилия                     |
| is_subscribed| BOOLEAN   | Подписан на канал           |
| received_file| BOOLEAN   | Получил PDF файл            |
| created_at   | TIMESTAMP | Дата регистрации            |
| last_active  | TIMESTAMP | Последняя активность        |

### Таблица: messages
| Поле         | Тип       | Описание                    |
|--------------|-----------|-----------------------------|
| id           | INTEGER   | PRIMARY KEY (auto)          |
| user_id      | INTEGER   | Telegram ID отправителя     |
| message_text | TEXT      | Текст сообщения             |
| is_from_admin| BOOLEAN   | От администратора?          |
| created_at   | TIMESTAMP | Дата отправки               |

## Переменные окружения (.env)

```env
# Обязательные
BOT_TOKEN          # Токен от @BotFather
ADMIN_ID           # Ваш Telegram ID
CHANNEL_ID         # ID канала или @username
CHANNEL_LINK       # Ссылка на канал

# Контент
ARTICLE_LINK       # Ссылка на статью
PDF_FILE_PATH      # Путь к PDF файлу

# База данных
DATABASE_PATH      # Путь к SQLite БД

# Сообщения (опционально)
WELCOME_MESSAGE
SUCCESS_MESSAGE
WORK_WITH_ME_MESSAGE
```

## Зависимости (requirements.txt)

- **aiogram 3.15.0** - Telegram Bot framework
- **python-dotenv 1.0.1** - Работа с .env
- **aiosqlite 0.20.0** - Асинхронная работа с SQLite
- **python-dateutil 2.9.0** - Работа с датами

## Docker

### Dockerfile
- Базовый образ: python:3.11-slim
- Устанавливает зависимости
- Копирует код и данные
- Запускает бота

### docker-compose.yml
- Сервис: telegram-bot
- Автоперезапуск: unless-stopped
- Volume: ./data (персистентность БД)
- Health check
- Логирование

## Workflow

### Пользовательский сценарий
1. Пользователь: `/start`
2. Бот: Приветствие + кнопки
3. Пользователь: "Подписаться" → переход на канал
4. Пользователь: Подписывается
5. Пользователь: "Я подписался"
6. Бот: Проверка подписки через API
7. Если подписан:
   - Бот: Ссылка на статью
   - Бот: PDF файл
   - Бот: Сообщение о работе
   - БД: Сохранение статуса
8. Пользователь: Пишет сообщение
9. Бот → Админ: Уведомление
10. Админ: Reply на сообщение
11. Бот → Пользователь: Ответ админа

### Администраторский сценарий
1. `/stats` - просмотр статистики
2. Reply на сообщение - ответ пользователю
3. Получение уведомлений о новых сообщениях

## Безопасность

- ✅ .env файл в .gitignore
- ✅ Проверка прав администратора
- ✅ Валидация user_id
- ✅ Обработка ошибок Telegram API
- ✅ Логирование всех действий

## Масштабирование

Текущая архитектура поддерживает до ~10,000 активных пользователей.

При росте аудитории:
- Переход на PostgreSQL
- Redis для кэширования
- Микросервисная архитектура
- Load balancing

## Мониторинг

- Логи: `bot.log` (локально)
- Docker logs: `docker-compose logs -f`
- Статистика: команда `/stats`
- Healthcheck в docker-compose.yml

## Резервное копирование

Важные данные:
- `data/bot.db` - база данных
- `.env` - конфигурация
- `data/bonus.pdf` - файл для отправки

Рекомендуется регулярный бэкап БД.
